<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quippet Settings</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #000000);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --btn-color: var(--tg-theme-button-color, #3390ec);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #1c1c1e);
            --card-bg: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- COMPACT TOP HEADER --- */
        .top-pane {
            flex-shrink: 0; 
            padding: 12px 0;
            background: rgba(20, 20, 20, 0.85); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
            backdrop-filter: blur(15px); /* –†–∞–∑–º—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–¥ –Ω–∏–º */
            -webkit-backdrop-filter: blur(15px);
            z-index: 20; 
            display: flex; justify-content: center; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }

        .preview-container {
            /* üî• –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ú–ê–õ–ï–ù–¨–ö–ê–Ø –í–´–°–û–¢–ê */
            height: 220px; 
            width: auto; 
            aspect-ratio: 9/16;
            background: #111;
            border-radius: 12px; 
            position: relative; overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s;
        }

        .preview-bg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=600&auto=format&fit=crop');
            background-size: cover; background-position: center;
            filter: blur(20px) brightness(0.6); 
            z-index: 0; transition: filter 0.3s ease;
        }

        .particle-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; mix-blend-mode: screen; opacity: 1.0; 
            z-index: 1; pointer-events: none; display: none;
        }
        
        /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ–±–ª–æ–∂–∫—É –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é */
        .preview-cover {
            width: 55%; aspect-ratio: 1; background-color: #333;
            position: absolute; top: 38%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=600&auto=format&fit=crop');
            background-size: cover; transition: border-radius 0.3s;
        }
        
        .preview-cover.vinyl { border-radius: 50% !important; animation: spin 4s linear infinite; }
        .preview-cover.vinyl::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 18%; height: 18%;
            background: #111; border-radius: 50%; transform: translate(-50%, -50%); display: block;
            border: 1px solid rgba(255,255,255,0.2);
        }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        
        #vizCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; }
        
        /* –£–º–µ–Ω—å—à–∏–ª–∏ —Ç–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é */
        .preview-text { position: absolute; bottom: 12%; width: 100%; text-align: center; z-index: 4; pointer-events: none; }
        .p-artist { font-size: 10px; font-weight: 700; color: white; text-shadow: 0 1px 5px rgba(0,0,0,0.8); }
        .p-track { font-size: 8px; color: rgba(255,255,255,0.7); margin-top: 2px; text-shadow: 0 1px 5px rgba(0,0,0,0.8); }

        /* --- CONTENT AREA --- */
        .scrollable-content {
            flex-grow: 1; overflow-y: auto; padding: 16px; padding-bottom: 90px;
            -webkit-overflow-scrolling: touch;
        }

        .label { 
            font-size: 12px; color: var(--hint-color); text-transform: uppercase; 
            margin-bottom: 8px; margin-left: 4px; display: block; font-weight: 600; letter-spacing: 0.5px;
        }
        .section { margin-bottom: 20px; }
        
        /* --- CARDS --- */
        .presets-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        
        .card-btn {
            background: var(--card-bg); 
            border-radius: 12px; padding: 10px 4px;
            text-align: center; cursor: pointer; 
            border: 1px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .card-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.15); }
        
        .card-btn.selected { 
            background: rgba(51, 144, 236, 0.15); 
            border-color: var(--btn-color); 
            color: var(--btn-color);
        }
        
        .emoji-icon { font-size: 18px; margin-bottom: 4px; }
        .card-name { font-size: 10px; font-weight: 500; }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; }

        /* --- CONTROLS --- */
        .control-row {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 12px 14px; border-radius: 14px; 
            margin-bottom: 6px; font-size: 14px; font-weight: 500;
        }
        .toggle { position: relative; display: inline-block; width: 42px; height: 24px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider-switch { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: #3a3a3c; border-radius: 34px; transition: .3s; 
        }
        .slider-switch:before { 
            position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; 
            background-color: white; border-radius: 50%; transition: .3s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider-switch { background-color: var(--btn-color); }
        input:checked + .slider-switch:before { transform: translateX(18px); }

        /* --- SLIDERS --- */
        .range-wrapper { 
            background: var(--card-bg); padding: 12px; border-radius: 14px; 
            margin-top: 6px; display: none; animation: slideDown 0.2s ease;
        }
        .range-wrapper.visible { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .range-header { display: flex; justify-content: space-between; font-size: 12px; color: var(--hint-color); margin-bottom: 8px; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: white; cursor: pointer; margin-top: -7px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: rgba(255,255,255,0.2); border-radius: 2px;
        }

        /* --- COLOR PICKER --- */
        .color-btn {
            width: 100%; height: 44px; border-radius: 14px; border: none;
            background: var(--card-bg); display: flex; align-items: center; justify-content: space-between;
            padding: 0 14px; font-size: 14px; font-weight: 500; cursor: pointer; position: relative;
        }
        .color-preview {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2);
        }
        input[type="color"] { position: absolute; opacity: 0; left: 0; top: 0; width: 100%; height: 100%; }

        /* --- MAIN BUTTON --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 12px 16px 20px 16px; 
            background: linear-gradient(0deg, var(--bg-color) 60%, rgba(0,0,0,0) 100%);
            z-index: 100;
        }
        .main-btn {
            width: 100%; background: var(--btn-color); color: white; border: none;
            padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 5px 15px -3px rgba(51, 144, 236, 0.5);
        }
        .main-btn:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <div class="top-pane">
        <div class="preview-container" id="previewBox">
            <div class="preview-bg" id="bgEl"></div>
            <img id="particleImg" class="particle-layer" src="" alt="">
            <div class="preview-cover" id="coverEl"></div>
            <div class="preview-text"><div class="p-artist">ARTIST</div><div class="p-track">Track Name</div></div>
            <canvas id="vizCanvas"></canvas>
        </div>
    </div>

    <div class="scrollable-content">
        
        <!-- –ü–†–ï–°–ï–¢–´ -->
        <div class="section">
            <span class="label">–ë—ã—Å—Ç—Ä—ã–µ —Å—Ç–∏–ª–∏</span>
            <div class="presets-row">
                <div class="card-btn" onclick="applyPreset('phonk')">
                    <span class="emoji-icon">üòà</span><span class="card-name">Phonk</span>
                </div>
                <div class="card-btn" onclick="applyPreset('lofi')">
                    <span class="emoji-icon">‚òïÔ∏è</span><span class="card-name">Lo-Fi</span>
                </div>
                <div class="card-btn" onclick="applyPreset('neon')">
                    <span class="emoji-icon">üëæ</span><span class="card-name">Neon</span>
                </div>
                <div class="card-btn" onclick="applyPreset('clean')">
                    <span class="emoji-icon">‚ú®</span><span class="card-name">Clean</span>
                </div>
            </div>
        </div>

        <!-- –ß–ê–°–¢–ò–¶–´ -->
        <div class="section">
            <span class="label">–ß–∞—Å—Ç–∏—Ü—ã</span>
            <div class="grid-4">
                <div class="card-btn selected" onclick="setParticle('none')" id="part-none"><span class="emoji-icon">üö´</span><span class="card-name">–ù–µ—Ç</span></div>
                <div class="card-btn" onclick="setParticle('tape')" id="part-tape"><span class="emoji-icon">üéûÔ∏è</span><span class="card-name">–ü–ª–µ–Ω–∫–∞</span></div>
                <div class="card-btn" onclick="setParticle('sparks')" id="part-sparks"><span class="emoji-icon">üî•</span><span class="card-name">–ò—Å–∫—Ä—ã</span></div>
                <div class="card-btn" onclick="setParticle('snow')" id="part-snow"><span class="emoji-icon">‚ùÑÔ∏è</span><span class="card-name">–°–Ω–µ–≥</span></div>
            </div>
        </div>

        <!-- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø -->
        <div class="section">
            <span class="label">–í–∏–¥ —Å–ø–µ–∫—Ç—Ä–∞</span>
            <div class="grid-3">
                <div class="card-btn selected" onclick="setMode('spectrum')" id="btn-spectrum"><span class="emoji-icon">üìä</span><span class="card-name">–°–ø–µ–∫—Ç—Ä</span></div>
                <div class="card-btn" onclick="setMode('bar')" id="btn-bar"><span class="emoji-icon">‚ûñ</span><span class="card-name">–õ–∏–Ω–∏—è</span></div>
                <div class="card-btn" onclick="setMode('circle')" id="btn-circle"><span class="emoji-icon">‚≠ïÔ∏è</span><span class="card-name">–ö—Ä—É–≥</span></div>
            </div>

            <div class="range-wrapper visible" style="margin-top: 8px;" id="roundContainer">
                <div class="range-header"><span>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ</span> <span id="roundVal">20</span></div>
                <input type="range" min="0" max="150" value="20" id="roundRange" oninput="updateRound(this.value)">
            </div>

            <div class="range-wrapper visible" style="margin-top: 8px;" id="barsContainer">
                <div class="range-header"><span>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å</span> <span id="barsVal">25</span></div>
                <input type="range" min="30" max="120" value="50" id="barsRange" oninput="updateBars(this.value)">
            </div>
        </div>

        <!-- –§–û–ù –ò –≠–§–§–ï–ö–¢–´ -->
        <div class="section">
            <span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            <div class="color-btn" style="margin-bottom: 8px;">
                <span>–¶–≤–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤</span>
                <div class="color-preview" id="colorPreview" style="background-color: #ffffff;"></div>
                <input type="color" id="colorInp" value="#ffffff" oninput="updateColor(this.value)">
            </div>
            
            <div class="control-row">
                <span>üíß –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞</span>
                <label class="toggle"><input type="checkbox" id="blurCheck" onchange="toggleBlur()"><span class="slider-switch"></span></label>
            </div>
            <div class="range-wrapper" id="blurRangeBox">
                <div class="range-header"><span>–°–∏–ª–∞ –±–ª—é—Ä–∞</span> <span id="blurVal">30</span></div>
                <input type="range" min="0" max="100" value="30" id="blurRange" oninput="updateBlurVal(this.value)">
            </div>

            <div class="control-row" style="margin-top: 8px;">
                <span>üíø –ö—Ä—É—Ç—è—â–∏–π—Å—è –í–∏–Ω–∏–ª</span>
                <label class="toggle"><input type="checkbox" id="vinylCheck" onchange="toggleVinyl()"><span class="slider-switch"></span></label>
            </div>
            
            <div class="control-row">
                <span>ü´® –¢—Ä—è—Å–∫–∞ –±–∞—Å–∞</span>
                <label class="toggle"><input type="checkbox" id="shakeCheck" onchange="toggleShake()"><span class="slider-switch"></span></label>
            </div>
            <div class="range-wrapper" id="shakeRangeBox">
                <div class="range-header"><span>–°–∏–ª–∞ —Ç—Ä—è—Å–∫–∏</span> <span id="shakeVal">20</span></div>
                <input type="range" min="5" max="50" value="20" id="shakeRange" oninput="updateShakeVal(this.value)">
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="main-btn" onclick="sendData()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let state = { 
            mode: 'spectrum', color: '#ffffff', vinyl: false, shake: false, shakePower: 20, 
            bars: 25, round: 20, blur: true, blurPower: 30, particle: 'none'
        };

        const particleSources = { 'none': '', 'tape': 'tape.gif', 'sparks': 'sparks.gif', 'snow': 'snow.gif' };

        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        const coverEl = document.getElementById('coverEl');
        const previewBox = document.getElementById('previewBox');
        const bgEl = document.getElementById('bgEl');
        const partImg = document.getElementById('particleImg');
        const colorPreview = document.getElementById('colorPreview');

        function haptic() { if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

        function resizeCanvas() { 
            const dpr = window.devicePixelRatio || 1;
            canvas.width = previewBox.clientWidth * dpr;
            canvas.height = previewBox.clientHeight * dpr;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const presets = {
            phonk: { mode: 'bar', color: '#ff0000', vinyl: true, shake: true, shakePower: 30, bars: 15, round: 0, blur: true, blurPower: 20, particle: 'tape' },
            lofi: { mode: 'circle', color: '#ffb6c1', vinyl: true, shake: false, shakePower: 20, bars: 50, round: 20, blur: true, blurPower: 40, particle: 'snow' },
            neon: { mode: 'spectrum', color: '#00ff00', vinyl: false, shake: true, shakePower: 15, bars: 40, round: 10, blur: true, blurPower: 30, particle: 'sparks' },
            clean: { mode: 'spectrum', color: '#ffffff', vinyl: false, shake: false, shakePower: 20, bars: 25, round: 20, blur: false, blurPower: 0, particle: 'none' }
        };

        function applyPreset(name) {
            haptic();
            const p = presets[name];
            state = { ...state, ...p };
            
            setMode(state.mode, false);
            updateColor(state.color, false); document.getElementById('colorInp').value = state.color;
            
            document.getElementById('vinylCheck').checked = state.vinyl; toggleVinyl(false);
            document.getElementById('shakeCheck').checked = state.shake; toggleShake(false);
            document.getElementById('blurCheck').checked = state.blur; toggleBlur(false);

            updateShakeVal(state.shakePower); document.getElementById('shakeRange').value = state.shakePower;
            updateBars(state.bars); document.getElementById('barsRange').value = state.bars;
            updateRound(state.round); document.getElementById('roundRange').value = state.round;
            updateBlurVal(state.blurPower); document.getElementById('blurRange').value = state.blurPower;

            setParticle(state.particle, false);
        }

        function setParticle(name, doHaptic=true) {
            if(doHaptic) haptic();
            state.particle = name;
            ['none', 'tape', 'sparks', 'snow'].forEach(p => {
                const btn = document.getElementById('part-' + p);
                if(btn) btn.classList.remove('selected');
            });
            document.getElementById('part-' + name).classList.add('selected');
            if (name === 'none') { partImg.style.display = 'none'; partImg.src = ""; } 
            else { partImg.src = particleSources[name]; partImg.style.display = 'block'; }
        }

        function toggleBlur(doHaptic=true) {
            if(doHaptic) haptic();
            state.blur = document.getElementById('blurCheck').checked;
            document.getElementById('blurRangeBox').classList.toggle('visible', state.blur);
            updateBgStyle();
        }

        function updateBlurVal(val) {
            state.blurPower = parseInt(val);
            document.getElementById('blurVal').innerText = val;
            updateBgStyle();
        }

        function updateBgStyle() {
            const radius = state.blur ? state.blurPower : 0;
            bgEl.style.filter = `blur(${radius}px) brightness(0.6)`;
        }
        
        document.getElementById('blurCheck').checked = state.blur;
        toggleBlur(false);

        function draw() {
            const dpr = window.devicePixelRatio || 1;
            if (canvas.width !== previewBox.clientWidth * dpr) resizeCanvas();

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = state.color;
            ctx.strokeStyle = state.color;
            ctx.shadowBlur = 8; ctx.shadowColor = state.color;

            if (state.shake && Math.random() > 0.8) {
                const offset = (Math.random() - 0.5) * (state.shakePower / 4); 
                previewBox.style.transform = `scale(0.99) translate(${offset}px, ${offset}px)`;
            } else { previewBox.style.transform = `scale(1)`; }

            const W = canvas.width; const H = canvas.height;
            const groundLevel = H * 0.94; 

            if (state.mode === 'spectrum') {
                const bars = state.bars; 
                let gap = 2 * dpr; 
                if (bars > 60) gap = 1 * dpr; if (bars > 90) gap = 0;
                const totalGapW = (bars - 1) * gap;
                const barW = (W - totalGapW) / bars;
                const startX = (W - (bars * barW + totalGapW)) / 2;

                for (let i = 0; i < bars; i++) {
                    const h = Math.random() * (H * 0.15) + (H * 0.05); 
                    ctx.fillRect(startX + i * (barW + gap), groundLevel - h, barW, h);
                }
            } else if (state.mode === 'bar') {
                const time = Date.now();
                const progress = (time % 4000) / 4000; 
                ctx.fillRect(0, groundLevel, W * progress, 8 * dpr);
            } else if (state.mode === 'circle') {
                const cx = W / 2; const cy = H * 0.38; const radius = (W * 0.6) / 2;
                const spacePerBar = (2 * Math.PI * radius) / state.bars;
                ctx.lineWidth = Math.max(2 * dpr, spacePerBar * 0.8);
                ctx.lineCap = 'round';
                const lines = state.bars; const step = (Math.PI * 2) / lines;
                for (let i = 0; i < lines; i++) {
                    const len = (Math.random() * 20 + 5) * dpr;
                    const angle = i * step - (Math.PI / 2);
                    ctx.beginPath();
                    ctx.moveTo(cx + Math.cos(angle) * radius, cy + Math.sin(angle) * radius);
                    ctx.lineTo(cx + Math.cos(angle) * (radius + len), cy + Math.sin(angle) * (radius + len));
                    ctx.stroke();
                }
            }
            requestAnimationFrame(draw);
        }
        draw();

        function setMode(mode, doHaptic=true) {
            if(doHaptic) haptic();
            state.mode = mode;
            ['spectrum', 'bar', 'circle'].forEach(m => document.getElementById('btn-' + m).classList.remove('selected'));
            document.getElementById('btn-' + mode).classList.add('selected');
            const barsContainer = document.getElementById('barsContainer');
            if(mode === 'bar') barsContainer.style.display = 'none'; else barsContainer.style.display = 'block';
        }
        
        function updateRound(val) {
            state.round = parseInt(val); document.getElementById('roundVal').innerText = val;
            if (!state.vinyl) coverEl.style.borderRadius = (val / 4) + 'px';
        }
        function updateColor(val, doHaptic=false) { 
            state.color = val; colorPreview.style.backgroundColor = val;
            if(doHaptic) haptic();
        }
        function toggleVinyl(doHaptic=true) {
            if(doHaptic) haptic();
            state.vinyl = document.getElementById('vinylCheck').checked;
            coverEl.classList.toggle('vinyl', state.vinyl);
            const roundBox = document.getElementById('roundContainer');
            if(state.vinyl) { roundBox.style.display = 'none'; coverEl.style.borderRadius = ''; } 
            else { roundBox.style.display = 'block'; coverEl.style.borderRadius = (state.round / 4) + 'px'; }
        }
        function toggleShake(doHaptic=true) {
            if(doHaptic) haptic();
            state.shake = document.getElementById('shakeCheck').checked;
            document.getElementById('shakeRangeBox').classList.toggle('visible', state.shake);
        }
        function updateShakeVal(val) { state.shakePower = val; document.getElementById('shakeVal').innerText = val; }
        function updateBars(val) { state.bars = parseInt(val); document.getElementById('barsVal').innerText = val; }
        function sendData() { haptic(); tg.sendData(JSON.stringify(state)); }
    </script>
</body>
</html>
