<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –í–∏–¥–µ–æ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #1c1c1e);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --btn-color: var(--tg-theme-button-color, #007aff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ß–ê–°–¢–¨ --- */
        .top-pane {
            flex-shrink: 0;
            padding: 10px;
            background-color: var(--bg-color);
            border-bottom: 1px solid #333;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-container {
            height: 38vh; 
            width: auto;
            aspect-ratio: 9/16;
            background: linear-gradient(45deg, #333, #111);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid #444;
            transition: transform 0.1s;
        }

        .preview-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; filter: blur(10px) brightness(0.6); z-index: 0;
        }
        .preview-cover {
            width: 60%; aspect-ratio: 1; background-color: #555;
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b2/A_black_background.jpg');
            background-size: cover; transition: border-radius 0.3s;
        }
        .preview-cover::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 15%; height: 15%;
            background: #111; border-radius: 50%; transform: translate(-50%, -50%); display: none;
        }
        .preview-cover.vinyl { border-radius: 50% !important; animation: spin 4s linear infinite; }
        .preview-cover.vinyl::after { display: block; }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        #vizCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; }
        .preview-text { position: absolute; top: 68%; width: 100%; text-align: center; z-index: 4; }
        .p-artist { font-size: 11px; font-weight: bold; color: white; }
        .p-track { font-size: 9px; color: #ddd; margin-top: 2px; }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ß–ê–°–¢–¨ --- */
        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 90px;
            -webkit-overflow-scrolling: touch;
        }

        .label { font-size: 12px; color: var(--hint-color); text-transform: uppercase; margin-bottom: 6px; display: block; font-weight: 600; }
        .section { margin-bottom: 18px; }
        
        .presets-row {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
            scrollbar-width: none;
        }
        .presets-row::-webkit-scrollbar { display: none; }
        .preset-card {
            background: var(--secondary-bg); min-width: 70px; padding: 8px;
            border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .preset-card:active { transform: scale(0.95); }
        .preset-icon { font-size: 20px; margin-bottom: 4px; }
        .preset-name { font-size: 10px; font-weight: 500; }

        .grid-select { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .card {
            background: var(--secondary-bg); border-radius: 10px; padding: 8px;
            text-align: center; cursor: pointer; border: 2px solid transparent; font-size: 11px;
        }
        .card.selected { border-color: var(--btn-color); background: rgba(0, 122, 255, 0.15); }
        .card-icon { font-size: 18px; display: block; margin-bottom: 3px; }
        .color-row {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--secondary-bg); padding: 8px 12px; border-radius: 10px;
        }
        input[type="color"] { border: none; width: 30px; height: 30px; background: none; }
        .switch-row {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--secondary-bg); padding: 10px 12px; border-radius: 10px; margin-bottom: 6px;
            font-size: 14px;
        }
        .toggle { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--btn-color); }
        input:checked + .slider:before { transform: translateX(18px); }
        .range-box { background: var(--secondary-bg); padding: 12px; border-radius: 10px; display: none; margin-top: 6px; }
        .range-box.visible { display: block; animation: fadeIn 0.3s; }
        input[type=range] { width: 100%; accent-color: var(--btn-color); margin-top: 8px;}
        
        .main-btn {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            background: var(--btn-color); color: white; border: none;
            padding: 14px; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="top-pane">
        <div class="preview-container" id="previewBox">
            <div class="preview-bg"></div>
            <div class="preview-cover" id="coverEl"></div>
            <div class="preview-text"><div class="p-artist">ARTIST NAME</div><div class="p-track">Track Title</div></div>
            <canvas id="vizCanvas"></canvas>
        </div>
    </div>

    <div class="scrollable-content">
        <div class="section">
            <span class="label">‚ú® –ì–æ—Ç–æ–≤—ã–µ —Å—Ç–∏–ª–∏</span>
            <div class="presets-row">
                <div class="preset-card" onclick="applyPreset('phonk')">
                    <span class="preset-icon">üòà</span><span class="preset-name">Phonk</span>
                </div>
                <div class="preset-card" onclick="applyPreset('lofi')">
                    <span class="preset-icon">‚òïÔ∏è</span><span class="preset-name">Lo-Fi</span>
                </div>
                <div class="preset-card" onclick="applyPreset('neon')">
                    <span class="preset-icon">üëæ</span><span class="preset-name">Neon</span>
                </div>
                <div class="preset-card" onclick="applyPreset('clean')">
                    <span class="preset-icon">üíß</span><span class="preset-name">Clean</span>
                </div>
            </div>
        </div>

        <div class="section">
            <span class="label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            <div class="grid-select">
                <div class="card selected" onclick="setMode('spectrum')" id="btn-spectrum"><span class="card-icon">üìä</span> –°–ø–µ–∫—Ç—Ä</div>
                <div class="card" onclick="setMode('bar')" id="btn-bar"><span class="card-icon">‚ûñ</span> –õ–∏–Ω–∏—è</div>
                <div class="card" onclick="setMode('circle')" id="btn-circle"><span class="card-icon">‚≠ïÔ∏è</span> –ö—Ä—É–≥</div>
            </div>

            <div class="range-box visible" style="margin-top: 10px;" id="roundContainer">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;"><span>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ</span> <span id="roundVal">20</span></div>
                <input type="range" min="0" max="150" value="20" id="roundRange" oninput="updateRound(this.value)">
            </div>

            <div class="range-box visible" style="margin-top: 10px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888;"><span>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å</span> <span id="barsVal">25</span></div>
                <input type="range" min="30" max="120" value="50" id="barsRange" oninput="updateBars(this.value)">
            </div>
        </div>

        <div class="section">
            <span class="label">–¶–≤–µ—Ç</span>
            <div class="color-row"><span>–¶–≤–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤</span><input type="color" id="colorInp" value="#ffffff" oninput="updateColor(this.value)"></div>
        </div>

        <div class="section">
            <span class="label">–≠—Ñ—Ñ–µ–∫—Ç—ã</span>
            <div class="switch-row">
                <span class="switch-label">üíø –í–∏–Ω–∏–ª</span>
                <label class="toggle"><input type="checkbox" id="vinylCheck" onchange="toggleVinyl()"><span class="slider"></span></label>
            </div>
            <div class="switch-row">
                <span class="switch-label">ü´® –¢—Ä—è—Å–∫–∞ (Shake)</span>
                <label class="toggle"><input type="checkbox" id="shakeCheck" onchange="toggleShake()"><span class="slider"></span></label>
            </div>
            <div class="range-box" id="shakeRangeBox">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px; color:#888;"><span>–°–∏–ª–∞</span> <span id="shakeVal">20</span></div>
                <input type="range" min="5" max="50" value="20" id="shakeRange" oninput="updateShakeVal(this.value)">
            </div>
        </div>
    </div>

    <button class="main-btn" onclick="sendData()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let state = { mode: 'spectrum', color: '#ffffff', vinyl: false, shake: false, shakePower: 20, bars: 25, round: 20 };
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        const coverEl = document.getElementById('coverEl');
        const previewBox = document.getElementById('previewBox');

        // üî• –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ—Å–∞–π–∑–∞ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function resizeCanvas() { 
            const dpr = window.devicePixelRatio || 1;
            const width = previewBox.clientWidth;
            const height = previewBox.clientHeight;
            
            // –§–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä (–¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏)
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç! 
            // –¢–µ–ø–µ—Ä—å –≤—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∏–∂–µ –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∫–∞–∫ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞,
            // –∞ –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É–º–Ω–æ–∂–∏—Ç –∏—Ö –Ω–∞ dpr.
            ctx.scale(dpr, dpr);
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const presets = {
            phonk: { mode: 'bar', color: '#ff0000', vinyl: true, shake: true, shakePower: 30, bars: 15, round: 0 },
            lofi: { mode: 'circle', color: '#ffb6c1', vinyl: true, shake: false, shakePower: 20, bars: 50, round: 20 },
            neon: { mode: 'spectrum', color: '#00ff00', vinyl: false, shake: true, shakePower: 15, bars: 40, round: 10 },
            clean: { mode: 'spectrum', color: '#ffffff', vinyl: false, shake: false, shakePower: 20, bars: 25, round: 20 }
        };

        function applyPreset(name) {
            const p = presets[name];
            state = { ...state, ...p };
            setMode(state.mode);
            updateColor(state.color); document.getElementById('colorInp').value = state.color;
            document.getElementById('vinylCheck').checked = state.vinyl; toggleVinyl();
            document.getElementById('shakeCheck').checked = state.shake; toggleShake();
            updateShakeVal(state.shakePower); document.getElementById('shakeRange').value = state.shakePower;
            updateBars(state.bars); document.getElementById('barsRange').value = state.bars;
            updateRound(state.round); document.getElementById('roundRange').value = state.round;
        }

        function draw() {
            const dpr = window.devicePixelRatio || 1;
            // –õ–æ–≥–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ (–±–µ–∑ —É—á–µ—Ç–∞ dpr, —Ç–∞–∫ –∫–∞–∫ –º—ã —Å–¥–µ–ª–∞–ª–∏ ctx.scale)
            const W = previewBox.clientWidth; 
            const H = previewBox.clientHeight;

            // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è, —Ä–µ—Å–∞–π–∑–∏–º
            if (Math.abs(canvas.width - W * dpr) > 2) resizeCanvas();

            // –ß–∏—Å—Ç–∏–º –∏—Å–ø–æ–ª—å–∑—É—è –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã
            ctx.clearRect(0, 0, W, H);
            
            ctx.fillStyle = state.color;
            ctx.strokeStyle = state.color;

            // –¢—Ä—è—Å–∫–∞
            if (state.shake && Math.random() > 0.8) {
                const offset = (Math.random() - 0.5) * (state.shakePower / 3); 
                previewBox.style.transform = `translate(${offset}px, ${offset}px)`;
            } else { previewBox.style.transform = `none`; }

            if (state.mode === 'spectrum') {
                const bars = state.bars; 
                // –£–º–Ω—ã–π –æ—Ç—Å—Ç—É–ø
                let gap = 2;
                if (bars > 60) gap = 1;
                if (bars > 90) gap = 0.5;
                if (bars > 110) gap = 0;

                const totalGapW = (bars - 1) * gap;
                const barW = (W - totalGapW) / bars;
                const startX = (W - (bars * barW + totalGapW)) / 2;

                for (let i = 0; i < bars; i++) {
                    const h = Math.random() * (H * 0.15) + (H * 0.05); 
                    ctx.fillRect(startX + i * (barW + gap), H * 0.85 - h, barW, h);
                }

            } else if (state.mode === 'bar') {
                ctx.fillRect((W - W*0.7)/2, H * 0.85, W*0.7, 6);
            
            } else if (state.mode === 'circle') {
                const cx = W / 2; 
                const cy = H * 0.4; 
                const radius = (W * 0.6) / 2;
                
                // –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏
                ctx.lineWidth = bars > 70 ? 1.5 : 3;
                
                const lines = state.bars;
                const step = (Math.PI * 2) / lines;
                
                for (let i = 0; i < lines; i++) {
                    const len = Math.random() * 20 + 5;
                    const angle = i * step - (Math.PI / 2);
                    
                    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é
                    ctx.beginPath();
                    ctx.moveTo(cx + Math.cos(angle) * radius, cy + Math.sin(angle) * radius);
                    ctx.lineTo(cx + Math.cos(angle) * (radius + len), cy + Math.sin(angle) * (radius + len));
                    ctx.stroke();
                }
            }
            requestAnimationFrame(draw);
        }
        draw();

        function setMode(mode) {
            state.mode = mode;
            ['spectrum', 'bar', 'circle'].forEach(m => document.getElementById('btn-' + m).classList.remove('selected'));
            document.getElementById('btn-' + mode).classList.add('selected');
        }
        function updateRound(val) {
            state.round = parseInt(val); document.getElementById('roundVal').innerText = val;
            if (!state.vinyl) coverEl.style.borderRadius = (val / 4) + 'px';
        }
        function updateColor(val) { state.color = val; }
        function toggleVinyl() {
            state.vinyl = document.getElementById('vinylCheck').checked;
            coverEl.classList.toggle('vinyl', state.vinyl);
            const roundBox = document.getElementById('roundContainer');
            if(state.vinyl) { roundBox.style.display = 'none'; coverEl.style.borderRadius = ''; } 
            else { roundBox.style.display = 'block'; coverEl.style.borderRadius = (state.round / 4) + 'px'; }
        }
        function toggleShake() {
            state.shake = document.getElementById('shakeCheck').checked;
            document.getElementById('shakeRangeBox').classList.toggle('visible', state.shake);
        }
        function updateShakeVal(val) { state.shakePower = val; document.getElementById('shakeVal').innerText = val; }
        function updateBars(val) { state.bars = parseInt(val); document.getElementById('barsVal').innerText = val; }
        function sendData() { tg.sendData(JSON.stringify(state)); }
    </script>
</body>
</html>
